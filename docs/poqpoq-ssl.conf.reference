<VirtualHost *:443>
    ServerName poqpoq.com
    ServerAlias www.poqpoq.com
    DocumentRoot /var/www/world

    # SSL Configuration - Will use poqpoq.com certificate after we create it
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/poqpoq.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/poqpoq.com/privkey.pem

    # Security Headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options SAMEORIGIN
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"


    # Proxy all API requests with proper ordering (most specific first)
    ProxyPreserveHost On

    # Audio files proxy
    ProxyPass /api/audio/ http://127.0.0.1:3011/api/audio/
    ProxyPassReverse /api/audio/ http://127.0.0.1:3011/api/audio/

    # BBWorlds Perception API - Specific routes first
    ProxyPass /world/perception/docs http://127.0.0.1:8003/docs
    ProxyPassReverse /world/perception/docs http://127.0.0.1:8003/docs
    ProxyPass /world/perception/openapi.json http://127.0.0.1:8003/openapi.json
    ProxyPassReverse /world/perception/openapi.json http://127.0.0.1:8003/openapi.json
    ProxyPass /world/perception/ http://127.0.0.1:8003/
    ProxyPassReverse /world/perception/ http://127.0.0.1:8003/

    # BBWorlds Cognition API (Port 8004) - Dual routing for compatibility
    # Regular HTTP proxying for /api/cognition
    ProxyPass /api/cognition/docs http://127.0.0.1:8004/docs
    ProxyPassReverse /api/cognition/docs http://127.0.0.1:8004/docs
    ProxyPass /api/cognition/openapi.json http://127.0.0.1:8004/openapi.json
    ProxyPassReverse /api/cognition/openapi.json http://127.0.0.1:8004/openapi.json
    ProxyPass /api/cognition/ http://127.0.0.1:8004/
    ProxyPassReverse /api/cognition/ http://127.0.0.1:8004/

    # Regular HTTP proxying for /world/cognition
    ProxyPass /world/cognition/docs http://127.0.0.1:8004/docs
    ProxyPassReverse /world/cognition/docs http://127.0.0.1:8004/docs
    ProxyPass /world/cognition/openapi.json http://127.0.0.1:8004/openapi.json
    ProxyPassReverse /world/cognition/openapi.json http://127.0.0.1:8004/openapi.json
    ProxyPass /world/cognition/ http://127.0.0.1:8004/
    ProxyPassReverse /world/cognition/ http://127.0.0.1:8004/

    # BBWorlds API - AI Companion Control
    ProxyPass /world/api/ http://127.0.0.1:8001/
    ProxyPassReverse /world/api/ http://127.0.0.1:8001/

    # API endpoints proxy
    ProxyPass /api/ http://127.0.0.1:3011/api/
    ProxyPassReverse /api/ http://127.0.0.1:3011/api/

    # Health check proxy
    ProxyPass /health http://127.0.0.1:3011/health
    ProxyPassReverse /health http://127.0.0.1:3011/health

    # Perception API WebSocket streams
    ProxyPass /ws/perception/ ws://localhost:8003/ws/perception/
    ProxyPassReverse /ws/perception/ ws://localhost:8003/ws/perception/

    # WebSocket proxy for AI companion chat
    ProxyPass /ws ws://localhost:8002/
    ProxyPassReverse /ws ws://localhost:8002/

    # Enable logging
    ErrorLog ${APACHE_LOG_DIR}/poqpoq-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/poqpoq-ssl-access.log combined

    <Location "/world/perception/docs">
        SetOutputFilter SUBSTITUTE
        Substitute "s|url: 04747/openapi.json04747|url: 04747/world/perception/openapi.json04747|"
    </Location>

    <LocationMatch "/docs$|/redoc$|/openapi\.json$|/world/api/docs$|/world/api/redoc$|/world/api/openapi\.json$|/gpt/docs$|/gpt/redoc$|/gpt/openapi\.json$|/world/perception/docs$|/world/perception/openapi\.json$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </LocationMatch>

    ProxyPass /nexus/ http://127.0.0.1:3020/
    ProxyPassReverse /nexus/ http://127.0.0.1:3020/

    # Enable WebSocket support for NEXUS
    RewriteEngine On

    # WebSocket routing for Cognition API
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteCond %{REQUEST_URI} ^/api/cognition/ws/ [NC]
    RewriteRule ^/api/cognition/ws/(.*) ws://127.0.0.1:8004/ws/$1 [P,L]

    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteCond %{REQUEST_URI} ^/world/cognition/ws/ [NC]
    RewriteRule ^/world/cognition/ws/(.*) ws://127.0.0.1:8004/ws/$1 [P,L]

    RewriteCond %{REQUEST_URI}  ^/nexus/socket.io [NC]
    RewriteCond %{QUERY_STRING} transport=websocket [NC]
    RewriteRule ^/nexus/socket\.io/(.*) ws://127.0.0.1:3020/socket.io/$1 [P,L]

    ProxyPass /ai-streams/ http://127.0.0.1:8005/
    ProxyPassReverse /ai-streams/ http://127.0.0.1:8005/

    # Enable WebSocket support for AI Streams
    ProxyPass /ai-streams/ws/ ws://127.0.0.1:8005/ai-streams/ws/
    ProxyPassReverse /ai-streams/ws/ ws://127.0.0.1:8005/ai-streams/ws/

    # ============================================
    # FLAT PATH ADDITIONS - Added 2025-09-02
    # Independent API paths to eliminate confusion
    # ============================================

    # 1. VOICE NINJA API - Standalone path
    ProxyPass /voice-ninja/ http://127.0.0.1:3011/
    ProxyPassReverse /voice-ninja/ http://127.0.0.1:3011/

    # 2. COGNITION API - Single canonical path
    ProxyPass /cognition/ http://127.0.0.1:8004/
    ProxyPassReverse /cognition/ http://127.0.0.1:8004/

    # 3. PERCEPTION API - Single canonical path
    ProxyPass /perception/ http://127.0.0.1:8003/
    ProxyPassReverse /perception/ http://127.0.0.1:8003/

    # 4. BBWORLDS API - Clear namespace
    ProxyPass /bbworlds/ http://127.0.0.1:8001/
    ProxyPassReverse /bbworlds/ http://127.0.0.1:8001/

    # 5. AI STREAMS API
    ProxyPass /ai-streams/ http://127.0.0.1:8005/
    ProxyPassReverse /ai-streams/ http://127.0.0.1:8005/

    # 6. BOB GPT API - Direct access
    ProxyPass /bob-gpt/ http://127.0.0.1:8081/
    ProxyPassReverse /bob-gpt/ http://127.0.0.1:8081/

    # 7. NEXUS API - Game state
    ProxyPass /nexus/ http://127.0.0.1:3020/
    ProxyPassReverse /nexus/ http://127.0.0.1:3020/

    # 8. MEMORY DASHBOARD API - Memory Analysis
    ProxyPass /memory-dashboard/ http://127.0.0.1:8009/
    ProxyPassReverse /memory-dashboard/ http://127.0.0.1:8009/

    # Black Box Animator V1 (archived - longer prefix must come first)
    Alias /animator-v1 /var/www/animator-v1
    <Directory /var/www/animator-v1>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted

        AddType model/gltf-binary .glb
        AddType model/gltf+json .gltf
        AddType application/octet-stream .fbx
        AddType model/vnd.collada+xml .dae
    </Directory>

    # Black Box Animator
    Alias /animator /var/www/animator
    <Directory /var/www/animator>
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted

        AddType model/gltf-binary .glb
        AddType model/gltf+json .gltf
        AddType application/octet-stream .fbx
        AddType model/vnd.collada+xml .dae
    </Directory>

    # Black Box Animator BETA (v2.1)
    # Added 2025-11-07 - Testing ground for v2.1 features
    Alias /animator-beta /var/www/animator-beta
    <Directory /var/www/animator-beta>
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted

        AddType model/gltf-binary .glb
        AddType model/gltf+json .gltf
        AddType application/octet-stream .fbx
        AddType model/vnd.collada+xml .dae
        AddType application/javascript .js
    </Directory>

    # Black Box Weight Painter (Skinner)
    Alias /skinner /var/www/skinner
    <Directory /var/www/skinner>
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted
        DirectoryIndex index.html

        AddType model/gltf-binary .glb
        AddType model/gltf+json .gltf
        AddType application/octet-stream .fbx
    </Directory>

    # Terraformer - BlackBox Terrain Studio
    Alias /terraformer /var/www/terraformer
    Alias /terrain-studio /var/www/terraformer
    <Directory /var/www/terraformer>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        DirectoryIndex index.html

        AddType application/javascript .js
        AddType application/typescript .ts
        AddType text/html .html
        AddType text/css .css
        AddType image/jpeg .jpg
    </Directory>

  # IK Solver Demos
  Alias /ik-solver /var/www/ik-solver

  # Adobe Demos
  Alias /adobe /var/www/adobe
  <Directory /var/www/adobe>
      Options Indexes FollowSymLinks
      AllowOverride None
      Require all granted
      DirectoryIndex index.html
  </Directory>

  # Raining Kangaroos - Research Landing Page
  Alias /rainingkangaroos /var/www/rainingkangaroos
  <Directory /var/www/rainingkangaroos>
      Options Indexes FollowSymLinks
      AllowOverride None
      Require all granted
      DirectoryIndex index.html

      AddType application/javascript .js
      AddType text/html .html
      AddType text/css .css
      AddType video/mp4 .mp4
  </Directory>

  # Black Box Scripter — Script Editor
  # Black Box Legacy — OAR to GLB Converter

  # BLACK BOX Legacy — OAR Converter API (Port 3010)
  ProxyPass /legacy/api/ http://127.0.0.1:3010/api/
  ProxyPassReverse /legacy/api/ http://127.0.0.1:3010/api/
  ProxyPass /legacy/health http://127.0.0.1:3010/health
  ProxyPassReverse /legacy/health http://127.0.0.1:3010/health
  ProxyPass /legacy/docs http://127.0.0.1:3010/docs
  ProxyPassReverse /legacy/docs http://127.0.0.1:3010/docs
  ProxyPass /legacy/redoc http://127.0.0.1:3010/redoc
  ProxyPassReverse /legacy/redoc http://127.0.0.1:3010/redoc
  ProxyPass /legacy/openapi.json http://127.0.0.1:3010/openapi.json
  ProxyPassReverse /legacy/openapi.json http://127.0.0.1:3010/openapi.json
  Alias /legacy /var/www/legacy
  <Directory /var/www/legacy>
      Options -Indexes +FollowSymLinks
      AllowOverride None
      Require all granted
      DirectoryIndex index.html

      AddType application/javascript .js
      AddType text/html .html
      AddType text/css .css
      AddType model/gltf-binary .glb
      AddType model/gltf+json .gltf
      AddType image/jpeg .jpg
  </Directory>
  Alias /scripter /var/www/scripter
  <Directory /var/www/scripter>
      Options -Indexes +FollowSymLinks
      AllowOverride None
      Require all granted
      DirectoryIndex index.html

      AddType application/javascript .js
      AddType text/html .html
      AddType text/css .css
  </Directory>


  # Black Box Landscaper — Procedural World Population
  Alias /landscaper /var/www/landscaper
  <Directory /var/www/landscaper>
      Options -Indexes +FollowSymLinks
      AllowOverride None
      Require all granted
      DirectoryIndex index.html

      AddType application/javascript .js
      AddType text/html .html
      AddType text/css .css
  </Directory>

  # poqpoq Marketplace — Virtual Goods (Next.js static export)
  Alias /marketplace /var/www/marketplace
  <Directory /var/www/marketplace>
      Options -Indexes +FollowSymLinks
      AllowOverride None
      Require all granted
      DirectoryIndex index.html

      AddType application/javascript .js
      AddType text/html .html
      AddType text/css .css
      AddType image/png .png
      AddType image/webp .webp
  </Directory>

  <Directory /var/www/ik-solver>
      Options Indexes FollowSymLinks
      AllowOverride None
      Require all granted
    
      # Enable CORS for ES6 modules
      Header set Access-Control-Allow-Origin "*"
      Header set Access-Control-Allow-Methods "GET, OPTIONS"
    
      # Correct MIME types for ES6 modules
      AddType application/javascript .js
        AddType application/typescript .ts
      AddType text/html .html
      AddType model/gltf-binary .glb
  </Directory>

</VirtualHost>

# BBWorlds v0.0.1 - AI-First Metaverse with Spatial Awareness

<Directory /var/www/world>
    Options Indexes FollowSymLinks
    AllowOverride All
    Require all granted

    # Proper MIME types for JavaScript modules
    AddType application/javascript .js
        AddType application/typescript .ts
    AddType application/json .json
    AddType text/css .css
    AddType model/gltf-binary .glb

    # CORS headers for GLB loading and Voice Ninja API calls
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization"
</Directory>

# Voice Ninja DocumentRoot Configuration
<Directory /var/www/voice-ninja/build>
    Options -Indexes +FollowSymLinks
    AllowOverride All
    Require all granted
    DirectoryIndex index.html

    # MIME types for modern web
    AddType application/javascript .js
        AddType application/typescript .ts
    AddType application/json .json
    AddType text/css .css

    # CORS headers for API access
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization"
</Directory>

# NEXUS Socket.IO Configuration
RewriteCond %{REQUEST_URI} ^/bbworlds/socket.io/ [NC]
RewriteCond %{HTTP:Upgrade} websocket [NC]
RewriteRule ^/bbworlds/socket.io/(.*) ws://localhost:3020/socket.io/$1 [P,L]

# Socket.IO polling fallback
ProxyPass /bbworlds/socket.io/ http://localhost:3020/socket.io/
ProxyPassReverse /bbworlds/socket.io/ http://localhost:3020/socket.io/

# ============================================
# GLOBAL FAVICON ALIASES (Oct 2025)
# Serve pOqpOq icons for all paths/services
# ============================================
Alias /favicon.ico /var/www/world/icon-32.png
Alias /pOqpOq.svg /var/www/world/pOqpOq.svg
Alias /icon-16.png /var/www/world/icon-16.png
Alias /icon-32.png /var/www/world/icon-32.png
Alias /icon-48.png /var/www/world/icon-48.png
Alias /icon-64.png /var/www/world/icon-64.png
Alias /icon-128.png /var/www/world/icon-128.png
Alias /icon-256.png /var/www/world/icon-256.png

# HTTP to HTTPS redirect
<VirtualHost *:80>
    ServerName poqpoq.com
    ServerAlias www.poqpoq.com
    Redirect permanent / https://poqpoq.com/
</VirtualHost>

